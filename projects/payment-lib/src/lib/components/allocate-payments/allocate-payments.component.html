<div class="allocate-payments">
  <ng-container *ngIf="viewStatus === 'mainForm'">
    <ccpay-error-banner *ngIf="errorMessage.showError" [errorMessage]="errorMessage"></ccpay-error-banner>
    <h1 class="govuk-heading-xl">Confirm association</h1>
    <h2 class="govuk-heading-l govuk-heading-l--custom">
      Amount to be allocated: {{amountForAllocation | currency:'GBP':'symbol-narrow':'1.2-2'}}
    </h2>
    <div class="payment-group-section" *ngIf="paymentGroup">
      <table class="govuk-table">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <td class="govuk-table__header" scope="col">Code</td>
            <td class="govuk-table__header" scope="col">Description</td>
            <td class="govuk-table__header" scope="col">Volume</td>
            <td class="govuk-table__header" scope="col">Fee amount</td>
            <td class="govuk-table__header" scope="col">Calculated amount</td>
            <td class="govuk-table__header" scope="col">Amount Due</td>
          </tr>
        </thead>
        <tbody class="govuk-table__body" >
          <tr class="govuk-table__row" *ngFor="let fee of paymentGroup.fees; let i = index;">
            <td class="govuk-table__cell govuk-table__cell--col1">{{fee.code}}</td>
            <td class="govuk-table__cell govuk-table__cell--col2"> {{fee.description}} </td>
            <td class="govuk-table__cell govuk-table__cell--col3"> {{fee.volume? fee.volume : '-'}} </td>
            <td class="govuk-table__cell govuk-table__cell--col4"> {{ fee.fee_amount | currency:'GBP':'symbol-narrow':'1.2-2' }} </td>
            <td class="govuk-table__cell govuk-table__cell--col5"> {{fee.calculated_amount | currency:'GBP':'symbol-narrow':'1.2-2'}} </td>
            <td class="govuk-table__cell govuk-table__cell--col6" [attr.rowspan]="paymentGroup.fees.length" *ngIf="i==0"> {{afterFeeAllocateOutstanding | currency:'GBP':'symbol-narrow':'1.2-2'}} </td>
          </tr>
        </tbody>
        <tbody class="govuk-table__body" *ngIf="paymentGroup.fees.length == 0">
          <td class="govuk-table__cell" colspan="6">No payments recorded</td>
        </tbody>
      </table>
    </div>
    <div class="govuk-warning-text" *ngIf="isRemainingAmountGtZero || isRemainingAmountLtZero || remainingAmount === 0">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text govuk-warning-text__custom">
      <span class="govuk-warning-text__assistive">Warning</span>
        {{paymentSectionLabel.title}} {{ remainingAmount | currency:'GBP':'symbol-narrow':'1.2-2' }}
      </strong>
    </div>
    <div class="govuk-form-group" *ngIf="isRemainingAmountGtZero || isRemainingAmountLtZero">
      <div class="govuk-form-group">
        <fieldset class="govuk-fieldset" aria-describedby="how-contacted-conditional-hint">
          <span id="how-contacted-conditional-hint" class="govuk-hint" [ngClass]="{'inline-error-message': paymentReasonHasError}">
            {{paymentSectionLabel.reason}}
          </span>
          <div [ngClass]="paymentReasonHasError ? 'govuk-radios govuk-radios--conditional form-group-error' : 'govuk-radios govuk-radios--conditional'" data-module="govuk-radios" *ngIf="isRemainingAmountGtZero">
            <div class="govuk-radios__item" *ngFor="let reason of reasonList.overPayment | keyValue" >
              <input class="govuk-radios__input" id="{{reason.key}}" name="paymentReason" type="radio" [(ngModel)]="paymentReason" value={{reason.value}}>
              <label class="govuk-label govuk-radios__label govuk-font__custom" for="how-contacted-conditional">
                {{reason.value}}
              </label>
            </div>
          </div>
          <div [ngClass]="paymentReasonHasError ? 'govuk-radios govuk-radios--conditional form-group-error' : 'govuk-radios govuk-radios--conditional'" data-module="govuk-radios" *ngIf="isRemainingAmountLtZero">
            <div class="govuk-radios__item" *ngFor="let reason of reasonList.shortFall | keyValue">
              <input class="govuk-radios__input" id="{{reason.key}}" name="paymentReason" type="radio" [(ngModel)]="paymentReason" value={{reason.value}}>
              <label class="govuk-label govuk-radios__label govuk-font__custom" for="how-contacted-conditional">
                {{reason.value}}
              </label>
            </div>
          </div>
        </fieldset>
      </div>
      <div class="govuk-form-group">
        <fieldset class="govuk-fieldset" aria-describedby="how-contacted-conditional-hint">
          <span id="how-contacted-conditional-hint" class="govuk-hint" [ngClass]="{'inline-error-message': paymentExplanationHasError}">
            Provide an explanatory note
          </span>
          <div [ngClass]="paymentExplanationHasError ? 'govuk-radios govuk-radios--conditional form-group-error' : 'govuk-radios govuk-radios--conditional'" data-module="govuk-radios" *ngIf="isRemainingAmountGtZero">
            <div class="govuk-radios__item" *ngFor="let explanation of explanationList.overPayment | keyValue">
              <input class="govuk-radios__input" id="{{explanation.key}}" name="paymentExplanation" type="radio" [(ngModel)]="paymentExplanation" value={{explanation.value}} (click)="selectRadioButton(explanation.key, 'explanation')">
              <label class="govuk-label govuk-radios__label govuk-font__custom" for="how-contacted-conditional">
                {{explanation.value}}
              </label>
            </div>
          </div>

          <div [ngClass]="paymentExplanationHasError ? 'govuk-radios govuk-radios--conditional form-group-error' : 'govuk-radios govuk-radios--conditional'" data-module="govuk-radios"  *ngIf="isRemainingAmountLtZero">
            <div class="govuk-radios__item" *ngFor="let explanation of explanationList.shortFall | keyValue" >
              <input class="govuk-radios__input" id="{{explanation.key}}" name="paymentExplanation" type="radio" [(ngModel)]="paymentExplanation" value={{explanation.value}} (click)="selectRadioButton(explanation.key, 'explanation')">
              <label class="govuk-label govuk-radios__label govuk-font__custom" for="how-contacted-conditional">
                {{explanation.value}}
              </label>
            </div>
          </div>
        </fieldset>
      </div>
    </div>

    <form [formGroup]="overUnderPaymentForm" novalidate>
      <div 
      [ngClass]="isMoreDetailsBoxHide ? 'govuk-radios__conditional govuk-radios__conditional--hidden' : isPaymentDetailsEmpty || isPaymentDetailsInvalid || paymentDetailsMinHasError || paymentDetailsMaxHasError ? 'govuk-radios__conditional inline-error-border' : 'govuk-radios__conditional'" 
      id="conditional-how-contacted-conditional-3">
        <div class="govuk-form-group">
          <span id="more-detail-hint" class="govuk-hint govuk-font__custom">
            Please enter details
          </span>
          <textarea 
            class="govuk-textarea" 
            [ngClass]="{'inline-error-class': isPaymentDetailsEmpty || isPaymentDetailsInvalid || paymentDetailsMinHasError || paymentDetailsMaxHasError}" 
            id="moreDetails" 
            name="moreDetails" 
            rows="5" 
          formControlName="moreDetails" >
          </textarea>
          <p class="inline-error-message" *ngIf="isPaymentDetailsEmpty || isPaymentDetailsInvalid || paymentDetailsMinHasError || paymentDetailsMaxHasError">
            <span *ngIf="isPaymentDetailsEmpty">Enter a explanation</span>
            <span *ngIf="isPaymentDetailsInvalid">Enter a valid explanation</span>
            <span *ngIf="paymentDetailsMinHasError">Explanation should be at least 3 characters.</span>
            <span *ngIf="paymentDetailsMaxHasError">Explanation should be 255 characters or under.</span>
          </p>
        </div>
      </div>
      <div class="govuk-form-group" *ngIf="isRemainingAmountGtZero || isRemainingAmountLtZero">
        <label class="govuk-label govuk-font__custom" for="userName">
          Enter your name
        </label>
        <input 
          class="govuk-input" 
          id="userName" 
          name="userName" 
          type="text"
          [ngClass]="{'inline-error-class': isUserNameEmpty || isUserNameInvalid}" 
        formControlName="userName">
        <p class="inline-error-message" *ngIf="isUserNameEmpty || isUserNameInvalid">
          <span *ngIf="isUserNameEmpty">Enter your name.</span>
          <span *ngIf="isUserNameInvalid">Enter a valid name</span>
        </p>
      </div>
      <div class="govuk-button--group">
        <button type="submit" [disabled]="isConfirmButtondisabled" [ngClass]="isConfirmButtondisabled ? 'button button--disabled' : 'button'" (click)="confirmAllocatePayement()">
          Confirm
        </button>
        <button type="button" class="button govuk-button--secondary" (click)="cancelAllocatePayment($event)">
          Cancel
        </button>
      </div>
    </form>
  </ng-container>
</div>

